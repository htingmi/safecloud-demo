<!DOCTYPE html>
<html lang="zh-Hant">
<meta http-equiv="refresh" content="0;url=http://savecloud.com" />
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SafeCloud 智慧交通雲｜台南勝利國小版</title>
  <style>
    :root{
      --blue:#1e88e5; --blue-600:#1565c0; --green:#2ecc71; --orange:#ff8f00;
      --bg:#f7fafc; --card:#ffffff; --muted:#64748b; --text:#0f172a; --text-soft:#334155;
      --border:rgba(0,0,0,.12); --shadow:0 10px 26px rgba(20,30,60,.08);
      --radius-xl:18px; --radius-lg:14px;
    }
    *{box-sizing:border-box} html{scroll-behavior:smooth}
    body{margin:0;font-family:"Segoe UI", Roboto, Noto Sans TC, Helvetica, Arial, sans-serif;color:var(--text);
      background:radial-gradient(1200px 600px at 80% -20%, #e6f0ff 0%, transparent 60%),
                 radial-gradient(900px 500px at -10% 20%, #f0f9ff 0%, transparent 60%),var(--bg);}
    header{position:sticky;top:0;z-index:50;backdrop-filter:blur(10px);background:rgba(255,255,255,.8);border-bottom:1px solid var(--border)}
    .nav{max-width:1200px;margin:0 auto;padding:14px 20px;display:flex;align-items:center;gap:14px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700;color:var(--text)}
    .brand .pill{font-size:12px;background:linear-gradient(135deg,#dbeafe,#dcfce7);padding:4px 10px;border-radius:999px;color:var(--text)}
    .nav-spacer{flex:1}
    .nav a{color:var(--text);text-decoration:none;font-weight:600;font-size:14px;padding:8px 12px;border-radius:10px;opacity:.95;border:1px solid transparent}
    .nav a:hover{background:rgba(0,0,0,.05);border-color:var(--border)}
    .hero{position:relative;overflow:hidden;background:linear-gradient(160deg, rgba(21,101,192,.10), rgba(30,136,229,.06) 40%, rgba(46,204,113,.06) 100%)}
    .hero-wrap{max-width:1200px;margin:0 auto;padding:80px 20px 110px;display:grid;grid-template-columns:1.2fr .8fr;gap:24px}
    .hero h1{font-size:40px;margin:0 0 10px;letter-spacing:.5px;color:var(--text)}
    .slogan{color:var(--muted);opacity:.95;font-size:18px}
    .actions{margin-top:20px;display:flex;gap:12px;flex-wrap:wrap}
    .btn{display:inline-flex;align-items:center;gap:8px;text-decoration:none;cursor:pointer;padding:12px 16px;border-radius:12px;border:1px solid var(--border);background:#f1f5f9;color:var(--text);font-weight:700;box-shadow:var(--shadow)}
    .btn.primary{background:linear-gradient(135deg,#e6f0ff,#e8f9ef);border-color:transparent;color:var(--text)}
    .btn:hover{transform:translateY(-1px);box-shadow:0 10px 32px rgba(20,30,60,.12)}
    .btn.small{padding:8px 12px;font-size:13px;box-shadow:none}
    .hero-card{align-self:center;background:var(--card);border:1px solid var(--border);border-radius:var(--radius-xl);padding:16px;box-shadow:var(--shadow)}
    .hero-card h3{margin:0 0 12px;font-size:16px;color:var(--text)}
    .hero-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .stat{background:#f8fafc;border:1px solid var(--border);border-radius:14px;padding:12px;text-align:center}
    .stat .muted{color:var(--muted)} .stat b{display:block;font-size:20px;color:var(--text)}
    .badge-warning{background:#fde68a;color:#7a5200;padding:2px 8px;border-radius:999px;font-size:12px}
    section{scroll-margin-top:80px}
    .wrap{max-width:1200px;margin:0 auto;padding:70px 20px}
    .h2{font-size:26px;margin:0 0 18px;display:flex;align-items:center;gap:10px;letter-spacing:.3px;color:var(--text)}
    .sub{color:var(--muted);margin-bottom:22px}
    .panel{background:var(--card);border:1px solid var(--border);border-radius:var(--radius-xl);box-shadow:var(--shadow)}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:18px}
    @media(max-width:900px){.hero-wrap{grid-template-columns:1fr}.grid-2{grid-template-columns:1fr}}

    /* Pickup */
    #pickup .panel{padding:18px}
    .form-card{background:#ffffff;border:1px solid var(--border);border-radius:var(--radius-lg);padding:16px}
    .field{display:grid;grid-template-columns:120px 1fr;gap:12px;align-items:center;margin-bottom:12px}
    select,input[type=date],input[type=time]{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#ffffff;color:var(--text)}
    .hint{margin-top:12px;font-size:13px;color:var(--muted)}
    .map-card{position:relative;background:#ffffff;border:1px solid var(--border);border-radius:var(--radius-lg);padding:12px;min-height:300px}
    .campus svg{width:100%;height:300px;display:block}
    .marker{cursor:pointer;transition:transform .15s ease,filter .15s ease}
    .marker:hover{transform:scale(1.08);filter:drop-shadow(0 6px 14px rgba(0,0,0,.15))}
    .marker.recommend circle{stroke:var(--green);stroke-width:3}

    /* 動態高亮（按“未接送”才顯示） */
    .ping{fill:none;stroke:#1e88e5;stroke-width:3;opacity:.85;animation:pulse 1.6s ease-out infinite}
    .pin-dot{fill:#1e88e5}
    @keyframes pulse{
      0%{r:10;opacity:.85}
      70%{r:22;opacity:0}
      100%{opacity:0}
    }

    /* Parking / Traffic / Bookings */
    #parking .panel,#traffic .panel,#bookings .panel{padding:18px}
    .lot-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
    @media(max-width:1024px){.lot-grid{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:640px){.lot-grid{grid-template-columns:1fr}}
    .lot{perspective:1000px;position:relative;height:130px}
    .lot-inner{position:absolute;inset:0;transition:transform .6s;transform-style:preserve-3d}
    .lot:hover .lot-inner{transform:rotateY(180deg)}
    .lot-face{position:absolute;inset:0;border-radius:var(--radius-lg);padding:14px;display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:10px;border:1px solid var(--border);box-shadow:var(--shadow);backface-visibility:hidden;background:#ffffff;color:var(--text)}
    .lot-front{background:#ffffff}.lot-back{background:#f8fafc;transform:rotateY(180deg);color:var(--muted)}
    .lamp{width:14px;height:14px;border-radius:50%;box-shadow:0 0 14px currentColor}
    .lamp.green{color:var(--green)} .lamp.yellow{color:#ffd54f} .lamp.red{color:#ff5252}
    .lot-title{font-weight:700;color:var(--text)} .chip{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);opacity:.9;color:var(--text)}
    .legend{display:flex;gap:12px;flex-wrap:wrap;font-size:13px;color:var(--muted)}
    .legend .dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px}
    .dot.green{background:var(--green)} .dot.red{background:#ff5252} .dot.blue{background:var(--blue)} .dot.yellow{background:#ffd54f}
    .chart-card,.route-card{background:#ffffff;border:1px solid var(--border);border-radius:var(--radius-lg);padding:12px}
    .chart svg{width:100%;height:240px;display:block}
    .route svg{width:100%;height:260px;display:block}

    /* 今日狀態 & 預約卡片 */
    #today .panel{padding:18px}
    .status-list{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media(max-width:900px){.status-list{grid-template-columns:1fr}}
    .status-item{display:grid;gap:8px;background:#ffffff;border:1px solid var(--border);border-radius:var(--radius-lg);padding:12px}
    .status-head{display:flex;justify-content:space-between;align-items:center}
    .status-actions{display:flex;gap:8px;flex-wrap:wrap}
    .pill{font-size:12px;padding:3px 8px;border-radius:999px;border:1px solid var(--border)}
    .pill.done{background:#dcfce7;border-color:#a7f3d0;color:#065f46}
    .pill.todo{background:#fee2e2;border-color:#fecaca;color:#7f1d1d}
    .pill.wait{background:#e5ecff;border-color:#cdd8ff;color:#1e3a8a}
    .cards{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
    @media(max-width:1024px){.cards{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:640px){.cards{grid-template-columns:1fr}}
    .card{background:#ffffff;border:1px solid var(--border);border-radius:var(--radius-lg);padding:16px;box-shadow:var(--shadow);display:grid;gap:10px;color:var(--text)}
    .card h4{margin:0}.card .meta{color:var(--muted);font-size:14px}
    .btn.warn{background:#fde68a;border:1px solid #f2c74b;color:#7a5200;font-weight:800}
    footer{border-top:1px solid var(--border);background:#f1f5f9}
    .footer-inner{max-width:1200px;margin:0 auto;padding:26px 20px 60px;color:var(--muted);display:grid;gap:10px}
    .footer-inner a{color:var(--blue);text-decoration:none}
    #pickup .reserve-cta{display:flex;justify-content:flex-end;margin-top:12px}
    #pickup .reserve-cta .btn.primary{background:#1e3a8a;color:#fff;border:1px solid #1e40af}
    #pickup .reserve-cta .btn.primary:hover{background:#1e40af;box-shadow:0 10px 24px rgba(30,64,175,.22);transform:translateY(-1px)}
    .toast{position:fixed;right:16px;bottom:16px;background:#111827;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;transition:opacity .25s, transform .25s;transform:translateY(10px)}
    .toast.show{opacity:1;transform:none}
  </style>
</head>
<body>
  <header>
    <nav class="nav">
      <div class="brand"><div class="pill">SafeCloud</div><div>智慧交通雲</div></div>
      <div class="nav-spacer"></div>
      <a href="#today">今日預約</a>
      <a href="#pickup">放學接送預約</a>
      <a href="#traffic">車流量</a>
      <a href="#parking">停車資訊</a>
      <a href="#bookings">我的預約</a>
    </nav>
  </header>

  <section class="hero" id="top">
    <div class="hero-wrap">
      <div>
        <h1>🌐 SafeCloud 智慧交通雲</h1>
        <div class="slogan">智慧接送．安全到家</div>
        <div class="actions">
          <a class="btn primary" href="#pickup">立即預約</a>
          <a class="btn" href="#today">查看今日狀態</a>
        </div>
      </div>
      <div class="hero-card">
        <h3>即時摘要</h3>
        <div class="hero-stats">
          <div class="stat"><span class="muted">校園周邊</span><b>順暢</b></div>
          <div class="stat"><span class="muted">圓環附近空位</span><b>26</b></div>
          <div class="stat"><span class="muted">提醒</span><b><span class="badge-warning">尖峰 16:30</span></b></div>
        </div>
      </div>
    </div>
  </section>

  <!-- 今日狀態 -->
  <section id="today">
    <div class="wrap">
      <h2 class="h2">✅ 今日狀態</h2>
      <div class="panel">
        <div id="todayList" class="status-list"></div>
        <div id="todayEmpty" class="empty" style="display:none;padding:10px 2px;">今天尚無預約，請到「放學接送預約」新增</div>
      </div>
    </div>
  </section>

  <!-- 放學接送預約 -->
  <section id="pickup">
    <div class="wrap">
      <h2 class="h2">📍 放學接送預約</h2>
      <div class="panel grid-2">
        <div class="form-card">
          <div class="field"><label for="date">放學日期</label><input id="date" type="date" /></div>
          <div class="field"><label for="slot">接送時段</label>
            <select id="slot">
              <option>07:00 - 07:15</option>
              <option>07:15 - 07:30</option>
              <option>07:45 - 08:00</option>
              <option>08:00 - 08:15</option>
              <option>16:15 - 16:30</option>
              <option>16:30 - 16:45</option>
              <option>16:45 - 17:00</option>
              <option>16:45 - 17:15</option>
            </select>
          </div>
          <div class="field"><label for="gate">接送地點</label>
            <select id="gate">
              <option value="A">圓環 A</option>
              <option value="B">圓環 B</option>
              <option value="C">圓環 C</option>
              <option value="D">圓環 D</option>
              <option value="E">懷恩街</option>
            </select>
          </div>
          <div class="field"><label for="note">備註</label><input id="note" type="text" placeholder="例如：改走懷恩街、臨停5分鐘內離場等"/></div>
          <div class="reserve-cta" id="reserve-cta">
            <button type="button" class="btn primary big" id="reserveBtn">我要預約</button>
          </div>
        </div>

        <div class="map-card campus">
          <p class="sub">校園周邊接送位置示意圖</p>
          <!-- 接送地圖：A/B/C/D + 懷恩街（E） -->
          <svg id="campusMap" viewBox="0 0 600 300" xmlns="http://www.w3.org/2000/svg" aria-label="校園地圖（勝利國小周邊—接送點）">
            <!-- 背景外框 -->
            <rect x="10" y="-20" width="580" height="340" rx="18" fill="#eef2ff" stroke="#d4dbe8" />

            <!-- 學校範圍 -->
            <rect x="220" y="60" width="320" height="150" rx="12" fill="#e6f0ff" stroke="#c9d4e5"/>
            <text x="380" y="145" fill="#334155" font-size="13" text-anchor="middle">臺南市東區 勝利國小</text>

            <!-- 主要道路 -->
            <path d="M200 20 V280" stroke="#b6c4d9" stroke-width="12"/>
            <text x="190" y="30" fill="#334155" font-size="12" transform="rotate(-90 190,30)">勝利路</text>
            <path d="M560 20 V280" stroke="#b6c4d9" stroke-width="12"/>
            <text x="530" y="20" fill="#334155" font-size="12" transform="rotate(-90 548,30)">長榮路二段</text>
            <path d="M120 60 H560" stroke="#b6c4d9" stroke-width="10"/>
            <text x="130" y="55" fill="#334155" font-size="12">懷恩街</text>
            <path d="M320 220 H560" stroke="#c4d0e2" stroke-width="8" stroke-dasharray="8 6"/>
            <text x="330" y="235" fill="#334155" font-size="11">長榮路二段281巷</text>

            <!-- 東門城圓環 -->
            <ellipse cx="200" cy="280" rx="70" ry="30" fill="#fdf2f2" stroke="#e5bfbf"/>
            <text x="200" y="285" fill="#334155" font-size="12" text-anchor="middle">東門城圓環</text>

            <!-- 接送點（五個） -->
            <g class="marker" id="ring-A">
              <circle cx="170" cy="255" r="9" fill="#2ecc71" />
              <text x="170" y="245" font-size="12" text-anchor="middle" fill="#334155">A</text>
              <title>接送點 A</title>
            </g>
            <g class="marker" id="ring-B">
              <circle cx="235" cy="255" r="9" fill="#2ecc71" />
              <text x="235" y="245" font-size="12" text-anchor="middle" fill="#334155">B</text>
              <title>接送點 B</title>
            </g>
            <g class="marker" id="ring-C">
              <circle cx="235" cy="305" r="9" fill="#2ecc71" />
              <text x="235" y="295" font-size="12" text-anchor="middle" fill="#334155">C</text>
              <title>接送點 C</title>
            </g>
            <g class="marker" id="ring-D">
              <circle cx="170" cy="305" r="9" fill="#2ecc71" />
              <text x="170" y="295" font-size="12" text-anchor="middle" fill="#334155">D</text>
              <title>接送點 </title>
            </g>
            <g class="marker" id="huai-en">
              <circle cx="250" cy="60" r="9" fill="#ffd54f" />
              <text x="250" y="55" font-size="12" text-anchor="middle" fill="#334155">懷恩</text>
              <title>懷恩街 接送點</title>
            </g>

            <!-- 動態高亮容器：按「未接送」時才會插入 -->
            <g id="dynMarker"></g>

            <!-- 圖例 -->
            <g font-size="12" fill="#334155">
              <rect x="20" y="18" width="10" height="10" rx="2" fill="#2ecc71"/><text x="36" y="27">圓環接送點 A-D</text>
              <rect x="20" y="48" width="10" height="10" rx="2" fill="#ffd54f"/><text x="36" y="57">懷恩街接送點</text>
            </g>
          </svg>
          <div class="legend" style="margin-top:10px">
            <span><span class="dot yellow"></span>壅擠</span>
            <span><span class="dot green"></span>暢通</span>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- 車流量（示意） -->
  <section id="traffic">
    <div class="wrap">
      <h2 class="h2">🚦 車流預測與最佳路線</h2>
      <p class="sub">尖峰時段建議優先走懷恩街（E），備選圓環 A–D 依來向就近半圈離場。</p>
      <div class="panel grid-2">
        <div class="chart-card chart">
          <svg viewBox="0 0 600 260" xmlns="http://www.w3.org/2000/svg" aria-label="車流量預測">
            <defs><linearGradient id="grad" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#1e88e5" stop-opacity=".20"/><stop offset="100%" stop-color="#2ecc71" stop-opacity=".08"/></linearGradient></defs>
            <rect x="0" y="0" width="600" height="260" fill="#f7fbff" rx="12" />
            <g stroke="#00000012" stroke-width="1">
              <path d="M40 40 H560"/><path d="M40 90 H560"/><path d="M40 140 H560"/><path d="M40 190 H560"/><path d="M40 240 H560"/>
              <path d="M100 20 V240"/><path d="M200 20 V240"/><path d="M300 20 V240"/><path d="M400 20 V240"/><path d="M500 20 V240"/>
            </g>
            <path d="M40 180 C 100 160, 150 150, 200 140 S 300 120, 340 125 S 420 150, 460 170 S 520 210, 560 200" stroke="#1e88e5" stroke-width="3" fill="url(#grad)"/>
            <g fill="#334155" font-size="11"><text x="40" y="255">現在</text><text x="160" y="255">+10 分</text><text x="260" y="255">+20 分</text><text x="360" y="255">+30 分</text></g>
          </svg>
          <div class="legend" style="margin-top:10px"><span><span class="dot blue"></span>預測車流</span></div>
        </div>

        <div class="route-card route">
          <svg viewBox="0 0 600 260" xmlns="http://www.w3.org/2000/svg" aria-label="路線圖（勝利國小周邊）">
            <rect x="0" y="0" width="600" height="260" fill="#f7fbff" rx="12" />
            <g stroke="#c5d1e8" stroke-width="10" stroke-linecap="round" fill="none">
              <path d="M100 220 V40"/>
              <path d="M500 220 V40"/>
              <path d="M60 80 H540"/>
              <path d="M320 200 H520" stroke-dasharray="8 8"/>
            </g>
            <ellipse cx="100" cy="210" rx="40" ry="20" fill="none" stroke="#ef4444" stroke-width="12"/>
            <path d="M60 80 H500" stroke="#1e88e5" stroke-width="6" stroke-linecap="round" stroke-dasharray="6 8" fill="none"/>
            <g fill="#334155" font-size="12">
              <text x="88" y="50" transform="rotate(-90 88,50)">勝利路</text>
              <text x="488" y="50" transform="rotate(-90 488,50)">長榮路二段</text>
              <text x="70" y="74">懷恩街</text>
              <text x="330" y="214">長榮路二段281巷</text>
              <text x="88" y="214">東門城圓環</text>
            </g>
          </svg>
        </div>
      </div>
    </div>
  </section>

  <!-- 停車資訊 -->
  <section id="parking">
    <div class="wrap">
      <h2 class="h2">🅿️ 東門城圓環周邊即時停車資訊</h2>
      <p class="sub">燈號：綠 = 充足、黃 = 剩餘不多、紅 = 已滿</p>
      <div class="panel">
        <div class="lot-grid">
          <div class="lot"><div class="lot-inner"><div class="lot-face lot-front"><div class="lamp green"></div><div class="lot-title">東門路·東門教會旁</div><div class="chip">剩餘 18</div></div><div class="lot-face lot-back"><div style="grid-column:1/-1;font-size:13px;color:var(--muted);">收費停車場 · 近圓環，步行 3–5 分鐘到校區</div></div></div></div>
          <div class="lot"><div class="lot-inner"><div class="lot-face lot-front"><div class="lamp green"></div><div class="lot-title">府連路·郵局對面</div><div class="chip">剩餘 22</div></div><div class="lot-face lot-back"><div style="grid-column:1/-1;font-size:13px;color:var(--muted);">收費停車場 · 建議改走懷恩街接送</div></div></div></div>
          <div class="lot"><div class="lot-inner"><div class="lot-face lot-front"><div class="lamp yellow"></div><div class="lot-title">東門城圓環·路側平行格</div><div class="chip">剩餘 6</div></div><div class="lot-face lot-back"><div style="grid-column:1/-1;font-size:13px;color:var(--muted);">標線已調整為平行格 · 尖峰不建議臨停</div></div></div></div>
          <div class="lot"><div class="lot-inner"><div class="lot-face lot-front"><div class="lamp red"></div><div class="lot-title">勝利路·校門前路邊格</div><div class="chip">已滿</div></div><div class="lot-face lot-back"><div style="grid-column:1/-1;font-size:13px;color:var(--muted);">前門車流大，多為短停 · 改後門/南側門較順</div></div></div></div>
          <div class="lot"><div class="lot-inner"><div class="lot-face lot-front"><div class="lamp green"></div><div class="lot-title">長榮路二段·路邊格</div><div class="chip">剩餘 12</div></div><div class="lot-face lot-back"><div style="grid-column:1/-1;font-size:13px;color:var(--muted);">南側門接送相對順暢 · 注意單雙號規定</div></div></div></div>
          <div class="lot"><div class="lot-inner"><div class="lot-face lot-front"><div class="lamp green"></div><div class="lot-title">懷恩街·路邊格</div><div class="chip">剩餘 8</div></div><div class="lot-face lot-back"><div style="grid-column:1/-1;font-size:13px;color:var(--muted);">可步行到校門 · 尖峰改道用</div></div></div></div>
        </div>
      </div>
    </div>
  </section>

  <!-- 我的預約 -->
  <section id="bookings">
    <div class="wrap">
      <h2 class="h2">📒 我的預約</h2>
      <div class="panel">
        <div id="cards" class="cards"></div>
        <div id="empty" class="empty" style="display:none;padding:10px 2px;">目前沒有任何預約，快去新增吧！</div>
      </div>
    </div>
  </section>

  <footer>
    <div class="footer-inner">
      <div>平台簡介：智慧交通雲平台，結合即時資料，提升校園交通安全與便利。</div>
      <div>聯絡資訊：Email：<a href="mailto:safecloud@gmail.com">safecloud@gmail.com</a> ｜ 聯繫單位：校園交通小組 ｜ 社群：
        <a href="#">Facebook</a> · <a href="#">Instagram</a> · <a href="#">LINE</a></div>
      <div>版權 © 智慧交通雲 2025</div>
    </div>
  </footer>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    // --------- 常數與工具 ----------
    const KEY = 'safecloud_bookings';
    // 與下拉一致的全時段（用於「最快可再次預約」計算）
    const SLOTS = [
      {label:'07:00 - 07:15', start:'07:00', end:'07:15'},
      {label:'07:15 - 07:30', start:'07:15', end:'07:30'},
      {label:'07:45 - 08:00', start:'07:45', end:'08:00'},
      {label:'08:00 - 08:15', start:'08:00', end:'08:15'},
      {label:'16:15 - 16:30', start:'16:15', end:'16:30'},
      {label:'16:30 - 16:45', start:'16:30', end:'16:45'},
      {label:'16:45 - 17:00', start:'16:45', end:'17:00'},
      {label:'16:45 - 17:15', start:'16:45', end:'17:15'}
    ];
    const GATES = [
      {key:'A', label:'圓環 A', markerId:'ring-A'},
      {key:'B', label:'圓環 B', markerId:'ring-B'},
      {key:'C', label:'圓環 C', markerId:'ring-C'},
      {key:'D', label:'圓環 D', markerId:'ring-D'},
      {key:'E', label:'懷恩街', markerId:'huai-en'}
    ];
    // 安全版 $ / $$（el 為 null 也不會報錯）
    const $  = (sel, el) => (el ?? document).querySelector(sel);
    const $$ = (sel, el) => [ ...(el ?? document).querySelectorAll(sel) ];

    function load(){ try{ return JSON.parse(localStorage.getItem(KEY)) || []; } catch(e){ return []; } }
    function save(list){ localStorage.setItem(KEY, JSON.stringify(list)); }
    function uid(){ return 'b_' + Math.random().toString(36).slice(2,9); }
    function todayYMD(){ const t=new Date(); return `${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,'0')}-${String(t.getDate()).padStart(2,'0')}`; }
    function parseHM(hm){ const [h,m]=hm.split(':').map(Number); return {h,m}; }
    function toDateTime(ymd, hm){ const [y,mo,d]=ymd.split('-').map(Number); const {h,m}=parseHM(hm); return new Date(y,mo-1,d,h,m,0,0); }
    function gateByKey(key){ return GATES.find(g=>g.key===key) || GATES[0]; }

    function nextAvailableAfter(ymd, hm){
      const now = new Date();
      const candidates = SLOTS.map(s=>({s, dt: toDateTime(ymd, s.start)})).filter(x=>x.dt>now);
      if (candidates.length){ const first=candidates.sort((a,b)=>a.dt-b.dt)[0]; return {ymd, label:first.s.label}; }
      const t = toDateTime(ymd, '07:00'); t.setDate(t.getDate()+1);
      return {ymd:`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,'0')}-${String(t.getDate()).padStart(2,'0')}`, label:SLOTS[0].label};
    }

    // --------- 地圖高亮（容錯） ----------
    function clearHighlight(){
      const map = $('#campusMap');
      if (!map) return;
      const dyn = $('#dynMarker', map);
      if (dyn) dyn.innerHTML='';
    }
    function highlightGate(key){
      const map = $('#campusMap');
      if (!map) return;
      const g = gateByKey(key);
      const group = $('#'+g.markerId, map);
      if (!group) return;
      const c = group.querySelector('circle');
      if (!c) return;
      const cx = Number(c.getAttribute('cx')), cy = Number(c.getAttribute('cy'));
      const dyn = $('#dynMarker', map);
      if (!dyn) return;
      dyn.innerHTML = `
        <circle class="ping" cx="${cx}" cy="${cy}"></circle>
        <circle class="pin-dot" cx="${cx}" cy="${cy}" r="4"></circle>
      `;
    }

    function showToast(text){ const el=$('#toast'); el.textContent=text; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),1800); }

    // --------- 渲染 ----------
    function render(){
      const list = load();
      renderCards(list);
      renderToday(list);
    }

    function renderCards(list){
      const container = $('#cards'); container.innerHTML='';
      if (!list.length){ $('#empty').style.display='block'; return; }
      $('#empty').style.display='none';
      list.sort((a,b)=>(a.date+a.slotStart).localeCompare(b.date+b.slotStart)).forEach(item=>{
        const card=document.createElement('div'); card.className='card'; card.dataset.id=item.id;
        const statusPill = item.status==='已接送'?'done':(item.status==='未接送'?'todo':'wait');
        card.innerHTML = `
          <h4>${gateByKey(item.gateKey).label} · ${item.slotLabel}</h4>
          <div class="meta">日期：${item.date}</div>
          ${item.note?`<div class="meta">備註：${item.note}</div>`:''}
          <div class="meta">狀態：<span class="pill ${statusPill}">${item.status}</span></div>
          <div class="btns">
            <button type="button" class="btn small warn" data-action="delete">取消</button>
            <button type="button" class="btn small" data-action="remind" style="background:linear-gradient(135deg,#e6f0ff,#e8f9ef);border:1px solid transparent;color:var(--text);">提醒</button>
          </div>`;
        container.appendChild(card);
      });
    }

    function renderToday(list){
      const ymd=todayYMD(); const wrap=$('#todayList'); wrap.innerHTML='';
      const todayItems=list.filter(x=>x.date===ymd && x.status!=='已接送');
      if (!todayItems.length){ $('#todayEmpty').style.display='block'; clearHighlight(); return; }
      $('#todayEmpty').style.display='none';

      todayItems.sort((a,b)=>a.slotStart.localeCompare(b.slotStart)).forEach(item=>{
        const div=document.createElement('div'); div.className='status-item'; div.dataset.id=item.id;
        const pillClass = item.status==='未接送'?'todo':'wait';
        let nextBlock = '';
        if (item.status==='未接送' && item.ack){
          const na=nextAvailableAfter(item.date,item.slotEnd);
          nextBlock=`<div class="next-time">最快可再次預約：${na.ymd} ${na.label}</div>`;
        }
        div.innerHTML = `
          <div class="status-head">
            <div><strong>${gateByKey(item.gateKey).label}</strong> · <span>${item.slotLabel}</span></div>
            <div><span class="pill ${pillClass}">${item.status==='未接送'?'未接送':'待接送'}</span></div>
          </div>
          ${item.note?`<div class="meta">${item.note}</div>`:''}
          ${nextBlock}
          <div class="status-actions">
            <button type="button" class="btn small" data-action="markDone">已接送</button>
            <button type="button" class="btn small warn" data-action="markTodo">未接送</button>
            <button type="button" class="btn small" data-action="delete">刪除</button>
          </div>`;
        wrap.appendChild(div);
      });
    }

    // --------- 狀態操作 ----------
    function addBooking({date, slotLabel, gateKey, note}){
      const slot=SLOTS.find(s=>s.label===slotLabel)||SLOTS[0];
      const item={ id:uid(), date, gateKey, note:note||'', slotLabel:slot.label, slotStart:slot.start, slotEnd:slot.end, status:'待接送', ack:false };
      const list=load(); list.push(item); save(list); render(); showToast('已新增到「我的預約」');
      clearHighlight(); // 新增後不顯示標記
    }
    function deleteBooking(id){ save(load().filter(x=>x.id!==id)); render(); showToast('已刪除預約'); clearHighlight(); }
    function editBooking(id){
      const list=load(); const it=list.find(x=>x.id===id); if(!it) return;
      $('#date').value=it.date; $('#slot').value=it.slotLabel; $('#gate').value=it.gateKey; $('#note').value=it.note||'';
      save(list.filter(x=>x.id!==id)); render(); location.hash='#pickup'; showToast('已回填表單，可以重新預約'); clearHighlight();
    }
    function remindBooking(id){ const it=load().find(x=>x.id===id); if(!it) return; showToast(`已設定提醒：${it.date} ${it.slotLabel} · ${gateByKey(it.gateKey).label}`); }

    function setStatus(id, status){
      const list=load(); const it=list.find(x=>x.id===id); if(!it) return;
      it.status=status;
      if (status==='未接送'){ it.ack=true; highlightGate(it.gateKey); }
      if (status==='已接送'){ it.ack=false; clearHighlight(); }
      save(list); render();
      showToast('已更新狀態');
    }

    // 「我的預約」卡片
    $('#cards').addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-action]');
      if (!btn) return;
      e.preventDefault(); e.stopPropagation();
      const id = btn.closest('.card')?.dataset.id;
      const act = btn.dataset.action;
      if (!id) return;
      if (act==='delete') deleteBooking(id);
      if (act==='edit')   editBooking(id);
      if (act==='remind') remindBooking(id);
    });

    // 「今日狀態」卡片（已接送 / 未接送）
    $('#todayList').addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-action]');
      if (!btn) return;
      e.preventDefault(); e.stopPropagation();
      const id  = btn.closest('.status-item')?.dataset.id;
      const act = btn.dataset.action;
      if (!id) return;
      if (act==='delete')   deleteBooking(id);
      if (act==='edit')     editBooking(id);
      if (act==='markDone') setStatus(id,'已接送'); // 卡片從今日狀態消失
      if (act==='markTodo') setStatus(id,'未接送'); // 顯示地圖標記與再次預約時間
    });

    // 新增預約
    $('#reserveBtn').addEventListener('click', ()=>{
      const date=$('#date').value || todayYMD();
      const slotLabel=$('#slot').value;
      const gateKey=$('#gate').value;
      const note=$('#note').value.trim();
      addBooking({date, slotLabel, gateKey, note});
    });

    // 初始化
    (function init(){
      const dateInput=$('#date'); if(dateInput && !dateInput.value) dateInput.value=todayYMD();
      render();
    })();
  </script>
</body>
</html>
